function CallbackFunction(returnValue) {
    if (returnValue)
        Xrm.Page.ui.controls.get("opportunityproductsGrid").refresh();
}

function onLoadOpp() {
    debugger;

    //$("#opportunityproductsGrid_contextualButtonsContainer").before("<div  id='addNewDiv' style='position: absolute; top: 0px; right: 0px; bottom: 0px; padding-right: 50px;'><img id='addNew' src='/webresources/spectra_plusbutton.png'  style='margin-bottom: 0px; border-top-width: 55px; padding-top: 0px; padding-bottom: 0px; padding-right: 40px; border-bottom-width: 55px;'></div>");
    //$("#opportunityproductsGrid_contextualButtonsContainer").after("<div id='teamTypeId' style='position: absolute;right: 0px;left: 200px;'></div>");


    $("#opportunityproductsGrid_addImageButton").click(function (event) {

        debugger;
        var id = Xrm.Page.data.entity.getId().replace("{", "").replace("}", "");
        var priceLevelId = Xrm.Page.getAttribute("pricelevelid").getValue();
		//alert(priceLevelId);
        if (priceLevelId == null) {
            alert("You must select a price list before attempting to add a product.");
            setTimeout(function () {
                document.getElementById("ProductGridFlyout_flyOut").style.display = "none";
            }, 200);
            return;
        }
        var customerSegmentCode = Xrm.Page.getAttribute("spectra_customersegmentcode").getValue();
         //alert(customerSegmentCode);
        if (customerSegmentCode == null) {
            alert("Please select a customer segment before attempting to add a product.");

            setTimeout(function () {
                document.getElementById("ProductGridFlyout_flyOut").style.display = "none";
            }, 200);
            return;
        }

        var oppAttributes = Xrm.Page.data.entity.attributes.get();
		//alert(oppAttributes);
        if (oppAttributes != null) {
            for (var i in oppAttributes) {
                if (oppAttributes[i].getIsDirty()) {
                    alert("Please Save the form and try again");
                    setTimeout(function () {
                        document.getElementById("ProductGridFlyout_flyOut").style.display = "none";
                    }, 200);
                    return;
                }
            }
        }


        var url = "WebResources/spectra_AddExistingProduct";
        //open dialog
        //Xrm.Internal.openDialog(Mscrm.CrmUri.create(url).toString(), DialogOptions, null, null, CallbackFunction);

        //var obj = new Object();
        //obj.Oppty = id;
        //obj.Price = priceLevelId[0].id.replace("{", "").replace("}", "");
        //obj.Seg = customerSegmentCode;
        //var oReturnValue = window.showModalDialog(url, obj, "dialogwidth: 55; dialogheight: 55; resizable: yes");

        //if (oReturnValue == true)
        //    Xrm.Utility.openEntityForm("opportunity", id);

        var x = screen.width / 2 - 700 / 2;
        var y = screen.height / 2 - 450 / 2;

        myWindow = window.open(url, "_blank", 'height=485,width=700,left=' + x + ',top=' + y);


        myWindow.onunload = function () {
            //window.location.reload(true);
            window.opener.location.reload();
            Xrm.Page.ui.controls.get("opportunityproductsGrid").refresh();
            var subgrid = Xrm.Page.ui.controls.get("opportunityproductsGrid");
            subgrid.refresh();
        }

        //myWindow.opener.parent.focus();

        setTimeout(function () {
            document.getElementById("ProductGridFlyout_flyOut").style.display = "none";
        }, 200);
    });
}

function InternetServices(oppId){
    var redundancy = Xrm.Page.getAttribute("alletech_redundancyrequired").getValue();
  
      var clientURL = Xrm.Page.context.getClientUrl();
      var urlfeas = clientURL + "/XRMServices/2011/Organizationdata.svc/alletech_feasibilitySet?$select=alletech_FeasiblityStatus&$filter=alletech_Opportunity/Id eq (guid'" + oppId + "')";
      var feasible = callAjax(urlfeas, "GET", false);
  
      if (feasible != null && feasible.results.length > 0) {
          for (var i = 0; i < feasible.results.length; i++) {
              if (feasible.results[i].alletech_FeasiblityStatus != null && feasible.results[i].alletech_FeasiblityStatus.Value != 1) {
                  alert("please complete the Feasiblity record");
                  return;
              }
              //if (!redundancy)
              //    break;
          }
      }
      else {
          //alletech_buildingname
          var building = Xrm.Page.getAttribute("alletech_buildingname").getValue();
  
          var urlbuild = clientURL + "/XRMServices/2011/Organizationdata.svc/alletech_buildingSet?"+
          "$select=alletech_BuildingStatus&$filter=alletech_buildingId eq (guid'" + building[0].id.replace("{", "").replace("}", "") 
          + "')";
          var build = callAjax(urlbuild, "GET", false);
  
          if (build != null && build.results.length > 0) {
              if (build.results[0].alletech_BuildingStatus != null && 
                build.results[0].alletech_BuildingStatus.Value == 1) {//Non RFS
                  alert("please create Feasiblity record");
                  return;
              }
          }
      }
  }
  
  function SDWANSevices(oppId){
    var grid = document.getElementById("CustomerSite").control;
          //alert('CustomerSite'+grid.GetRecordsFromInnerGrid().length);
          if (grid.GetRecordsFromInnerGrid().length == 0) {
              alert('Fill minimum One records in CustomerSite');
              return;
          }
          else
          {     
  
          if (document.getElementById("Presales_Task")) {
          var grid2 = document.getElementById("Presales_Task").control;
          //alert(grid2.GetRecordsFromInnerGrid().length);
          
          //alert(grid2.GetRecordsFromInnerGrid()[0][3].cells[3].outerText);
  
              if (grid2.GetRecordsFromInnerGrid().length < 1) {
                          alert('Fill  One records in Presales_Task');
                          return;
                      }
  
  
                  if(grid2.GetRecordsFromInnerGrid()[0][3].cells[3].outerText == 'Approved')
                  {
                      Mscrm.CommandBarActions.opportunityClose(true);
                  }
                  else
                  {
                      alert('Task Is Not Approved');
                      return;
                  }
      }
      else {
          setTimeout("GetSubGridRows();", 2500);
      }
         
      }
  }
  
  function approval() {
    //alert("hi");
    debugger;
    var oppId = Xrm.Page.data.entity.getId();
    var subSegName = Xrm.Page.getAttribute("alletech_subbusinesssegment").getValue()[0].name;
    if (subSegName != "SDWAN") {
        internetservice(oppId);
    }
    // else if(subSegName == "SDWAN"){
    //   SDWANSevices(oppId);
    // }
   // alert("kkkkk");
    var url = Xrm.Page.context.getClientUrl();
    url = url + "/XRMServices/2011/Organization.svc/web";
    var requestMain = "";
 // alert(url);
    requestMain = "<s:Envelope xmlns:s='http://schemas.xmlsoap.org/soap/envelope/'>" +
        "  <s:Body>" +
        "    <Execute xmlns='http://schemas.microsoft.com/xrm/2011/Contracts/Services' xmlns:i='http://www.w3.org/2001/XMLSchema-instance'>" +
        "      <request xmlns:a='http://schemas.microsoft.com/xrm/2011/Contracts'>" +
        "        <a:Parameters xmlns:b='http://schemas.datacontract.org/2004/07/System.Collections.Generic'>" +
        "          <a:KeyValuePairOfstringanyType>" +
        "            <b:key>Target</b:key>" +
        "            <b:value i:type='a:EntityReference'>" +
        "              <a:Id>" + oppId + "</a:Id>" +
        "              <a:KeyAttributes xmlns:c='http://schemas.microsoft.com/xrm/7.1/Contracts' />" +
        "              <a:LogicalName>opportunity</a:LogicalName>" +
        "              <a:Name i:nil='true' />" +
        "              <a:RowVersion i:nil='true' />" +
        "            </b:value>" +
        "          </a:KeyValuePairOfstringanyType>" +
        "        </a:Parameters>" +
        "        <a:RequestId i:nil='true' />" +
        "        <a:RequestName>spectra_CreateApprovals</a:RequestName>" +
        "      </request>" +
        "    </Execute>" +
        "  </s:Body>" +
        "</s:Envelope>";
  
    var copiedQuoteId = null;
  
    $ = parent.$;
    $.ajax({
        type: "POST",
        contentType: "text/xml; charset=utf-8",
        async: false,
        datatype: "json",
        url: url,
        Accept: "application/xml, text/xml, */*",
        data: requestMain,
        beforeSend: function (XMLHttpRequest) {
            //Specifying this header ensures that the results will be returned as JSON.
            XMLHttpRequest.setRequestHeader("SOAPAction", "http://schemas.microsoft.com/xrm/2011/Contracts/"+
            "Services/IOrganizationService/Execute");
        },
        success: function (data, textStatus, xhr) {
            Xrm.Utility.openEntityForm(Xrm.Page.data.entity.getEntityName(), Xrm.Page.data.entity.getId());
           // alert("Sus: "+Xrm.Utility.openEntityForm(Xrm.Page.data.entity.getEntityName(), Xrm.Page.data.entity.getId()));
            //alert("gg: "+Xrm.Page.data.entity.getEntityName());
            //alert("kkkk: "+Xrm.Page.data.entity.getId());
            //Xrm.Page.ui.controls.get("Approvals").refresh();
            //Xrm.Page.ui.refreshRibbon();
            //var str = xhr.responseXML.firstChild.innerHTML;
            //if (str != undefined || str != null) {
            //    copiedQuoteId = str.slice(str.indexOf("<a:Id>") + 6, str.indexOf("</a:Id>"));
            //}
            //else {
            //    copiedQuoteId = xhr.responseXML.getElementsByTagName("a:Id")[0].textContent;
            //}
            //Xrm.Utility.openEntityForm("hw_salesquote", copiedQuoteId);
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            var e = XMLHttpRequest.responseXML.getElementsByTagName("faultstring")[0].textContent;
            e = e.replace("Unexpected exception from plug-in (Execute):"+
            " QMS.Workflows.CopySalesQuote: System.Exception:", "");
            var x = screen.width / 3;
            var y = screen.height / 2.4;
            var myWindow = window.open("", "MsgWindow", "directories=no,titlebar=no,toolbar=no,location=no,"+
            "status=no,menubar=no,scrollbars=no,resizable=no,width=500, height=50, left=" + x + ",top=" + y);
            myWindow.document.write("<html><head><meta charset='utf-8'><meta></head><body style='text-align:"+
            " left; color: rgb(60, 60, 60); font-family: Segoe UI; font-size: 12px;'>");
            myWindow.document.getElementsByTagName('body')[0].innerHTML = '';
            myWindow.document.write(e);
            myWindow.document.write("</body></html>");
            myWindow.document.focus();
        }
    });
  }
  


function hideWonButton() {
    debugger;
    var formName = Xrm.Page.getAttribute("alletech_businesssegmentglb").getValue()[0].name;
    if (formName == "Business") {
        var subSegName = Xrm.Page.getAttribute("alletech_subbusinesssegment").getValue()[0].name;
            if (subSegName != "SDWAN") {
                var ret = hidewonInternet();
                return(ret);
            }
            else{
                var ret1 = hidewonsdwan();
                return(ret1);
            }
        
    }
    else {
        return true;
    }
    return false;
}


function hideStatusForHome() {
    var formName = Xrm.Page.ui.formSelector.getCurrentItem().getLabel();
    if (formName == "Home Opportunity Form") {
        Xrm.Page.getControl("header_statuscode").removeOption(569480013);
        Xrm.Page.getControl("header_statuscode").removeOption(569480014);
    }
}
//show hide submit approval
function hideSubmitForApprovalButton() {
    debugger;
    var formName = Xrm.Page.ui.formSelector.getCurrentItem().getLabel();
    if (formName == "Business Opportunity Form") {
    var subSegName = Xrm.Page.getAttribute("alletech_subbusinesssegment").getValue()[0].name;
    if (subSegName != "SDWAN") {
        var ret = biaApproval();
        return ret;
    }
    else if(subSegName == "SDWAN"){
      var ret = sdwanapproval();
      return ret;
    }
    }
    
}


function sdwanapproval(){
    
    debugger;
    var approvalflag = Xrm.Page.getAttribute("spectra_approvalrequiredflag").getValue();
    if (approvalflag != null && approvalflag == true) {
        //alert(Xrm.Page.getAttribute("statuscode").getValue());
        if(Xrm.Page.getAttribute("statuscode").getValue()==569480013)
            return false;
        else
            return true;
    }
    // else if (Xrm.Page.getAttribute("statuscode").getValue()==569480013)
    //     return false;
    else
        return false;
}

function biaApproval(){
    try {
        var formName = Xrm.Page.getAttribute("alletech_businesssegmentglb").getValue()[0].name;
        if (formName == "Business") {
            var oppId = Xrm.Page.data.entity.getId();
            //var building = Xrm.Page.getAttribute("alletech_buildingname").getValue();
            var approvalflag = Xrm.Page.getAttribute("spectra_approvalrequiredflag").getValue();

            if (approvalflag != null && approvalflag == true) {
                return true;
                //var clientURL = Xrm.Page.context.getClientUrl();
                ////var urlApproval = clientURL + "/XRMServices/2011/Organizationdata.svc/spectra_approvalSet?$select=spectra_name&$filter=spectra_OpportunityId/Id eq (guid'" + oppId + "') and statecode/Value eq 0";
                //var urlApproval = clientURL + "/XRMServices/2011/Organizationdata.svc/spectra_approvalSet?$select=spectra_name,statuscode&$filter=spectra_OpportunityId/Id eq (guid'" + oppId + "') and statecode/Value eq 0&$orderby=statuscode%20desc";
                //var approval = callAjax(urlApproval, "GET", false);

                //if (approval.results != null && approval.results.length > 0)
                //{
                //    var app = 0,rej=0;
                //    for (var i = 0; approval.results.length > i; i++) {
                //        var status = approval.results[i].statuscode.Value;

                //        //if even one record is pending then dont show button
                //        if (status != 1 && status != 111260000) {
                //            if (status == 111260001)
                //                app++;
                //            else
                //                rej++;
                //        }
                //        else
                //            return false;
                //    }

                //    //incase all are false, show submit for approval else dont show
                //    if (rej == approval.results.length)
                //        return true;
                //    else
                //        return false;
                //}
                //else
                //    return true;
            }
            else
                return false;
        }
    }
    catch (ex) {
        return false;
    }
}

function ApprovalRequiredFlagChange() {
    Xrm.Page.ui.refreshRibbon();
    var reason = Xrm.Page.getAttribute("customerneed");
    var approvalflag = Xrm.Page.getAttribute("spectra_approvalrequiredflag").getValue();
    if (approvalflag != null && approvalflag == true) {
        Xrm.Page.getAttribute("customerneed").setRequiredLevel("required");
    }
    else
    Xrm.Page.getAttribute("customerneed").setRequiredLevel("none");
    Xrm.Page.data.entity.save();
    Xrm.Page.ui.refreshRibbon();
    
}

function societyBuildingOnchange() {
    debugger;
    var lookupObj = Xrm.Page.getAttribute("alletech_buildingname");
    if (lookupObj != null) {
        var lookupObjValue = lookupObj.getValue();
        if (lookupObjValue != null) {
            lookupRecordGuid = lookupObjValue[0].id; // To get record GUID            
            var cols = ["alletech_buildingstatus"];
            var building = XrmServiceToolkit.Soap.Retrieve("alletech_building", lookupRecordGuid, cols);
            if (building.attributes["alletech_buildingstatus"] != undefined) {

                var obj = building.attributes["alletech_buildingstatus"];
                if (obj != null) {
                    var optionSetValue = obj.value;
                    if (optionSetValue == 5 || optionSetValue == 6 || optionSetValue == 2 || optionSetValue == 3 || optionSetValue == 4) { Xrm.Page.getAttribute("spectra_lastmileconnectivity").setValue(111260000); }
                    if (optionSetValue == 1) {
                        Xrm.Page.getAttribute("spectra_lastmileconnectivity").setValue(111260001);
                    }
                }
            }
        }
    }
}

function HidePlusButton() {
    debugger;
    $("#opportunityproductsGrid_addImageButtonImage").css("display", "none");
}

function callAjax(url, type, async) {
    var record = null;
    $ = parent.$;
    $.support.cors = true;
    $.ajax({
        url: url,
        type: type,
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        async: async,
        beforeSend: function (XMLHttpRequest) {
            //Specifying this header ensures that the results will be returned as JSON.
            XMLHttpRequest.setRequestHeader("Accept", "application/json");

        },
        success: function (data, textStatus, XMLHttpRequest) {
            record = data.d;

        },

        error: function (XMLHttpRequest, textStatus, errorThrown) {
            alert("An error has occurred with status" + textStatus + " at " + errorThrown);
        }

    });
    //Returns the Retrieved record
    return record;
}


function hidewonInternet(){
    debugger;
    var approvalflag = Xrm.Page.getAttribute("spectra_approvalrequiredflag").getValue();
		var status=Xrm.Page.getAttribute("statuscode").getValue();

        if (approvalflag || status == 569480013) {
            return false;
        }
        else {
            //var clientURL = Xrm.Page.context.getClientUrl();
            //var urlApproval = clientURL + "/XRMServices/2011/Organizationdata.svc/spectra_approvalSet?$select=spectra_name&$filter=spectra_OpportunityId/Id eq (guid'" + oppId + "') and statuscode/Value ne 111260001";
            //var approval = callAjax(urlApproval, "GET", false);
            //if (approval.results != null && approval.results.length > 0)
            //    return false;
            //else
                return true;
        }
}

function hidewonsdwan(){
    debugger;
    var approvalflag = Xrm.Page.getAttribute("spectra_approvalrequiredflag").getValue();
    
        if (approvalflag || status == 569480013) {
            return false;
        }
        else {
            return true;
        }
}
